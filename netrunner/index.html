<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netrunner</title>
    <div style="display: none;">
        TODO:
        - deck cotaining cards
        - token context menu
        - card context menu
        - add custom events for grab, move, ungrab
        - select oldest card art, lowest id?
    </div>
</head>

<body>
    <div id="start-game-panel" class="modal fade hide show" style="display: block; background-color: rgba(0, 0, 0, 0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered" style="--bs-modal-width: 600px;">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Start game</h1>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-around align-items-center m-3">
                        <div style="flex: 0 1 100px;">Host game:</div>
                        <input id="your-host-id" type="text" style="flex: 1 1 auto;" placeholder="Your host ID" title="Your host ID" readonly value="91eb3626-fe07-4adf-9a73-7496eb1e9b8b">
                        <button id="host-game" class="btn btn-outline-primary ms-3" style="flex: 0 1 100px;">Copy</button>
                    </div>
                    <div class="d-flex justify-content-around align-items-center m-3">
                        <div style="flex: 0 1 100px; width: 60px;">Join game:</div>
                        <input id="opponent-host-id" type="text" style="flex: 1 1 auto;" placeholder="Paste host ID" title="Paste host ID">
                        <button id="join-game" class="btn btn-outline-primary ms-3" style="flex: 0 1 100px;">Join</button>
                    </div>
                    <div class="d-flex justify-content-around align-items-center m-3">
                        <div style="flex: 0 1 100px; width: 60px;">Solo mode:</div>
                        <input type="text" style="flex: 1 1 auto;" placeholder="No host needed" title="No host needed" disabled>
                        <button id="play-solo" class="btn btn-outline-primary ms-3" style="flex: 0 1 100px;">Play</button>
                    </div>
                </div>
                <div class="modal-footer justify-content-start text-secondary">
                    <p>To host a game pass your host ID to a second player.</p>
                    <p>To join a game paste host ID you were given and confirm.</p>
                    <p>You can also start a solo game without using host ID.</p>
                </div>
            </div>
        </div>
    </div>
      
    <div>
        <div id="resource-panel" class="offcanvas offcanvas-start" style="width: 250px; background-color: aliceblue; z-index: 15;" tabindex="-1">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title">Resource panel</h5>
            </div>
            <div class="offcanvas-body d-flex flex-column align-items-center">
                <ul>
                    <li>Credit
                        <div id="credit" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Credit / Advancement">
                            <img style="transform: translate(-45px, -50px);" src="assets/credit.jpg">
                        </div>
                    </li>
                    <li>Advancement
                        <div id="advancement" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 256px; height: 256px; transform: scale(0.171875); margin: -104px;" title="Advancement / Credit">
                            <img style="transform: translate(-4px, -5px);" src="assets/click.jpg">
                        </div>
                    </li>
                    <li>Power
                        <div id="power" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Power / Virus">
                            <img style="transform: translateX(-256px) translate(-45px, -47px);" src="assets/virus.jpg">
                        </div>
                    </li>
                    <li>Virus
                        <div id="virus" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Virus / Power">
                            <img style="transform: translate(-45px, -47px);" src="assets/virus.jpg">
                        </div>
                    </li>
                    <li>Tag
                        <div id="tag" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Tag / Bad publicity">
                            <img style="transform: translate(-45px, -50px);" src="assets/tag.jpg">
                        </div>
                    </li>
                    <li>Bad publicity
                        <div id="bad-publicity" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Bad publicity / Tag">
                            <img style="transform: translate(-40px, -45px);" src="assets/bad_publicity.jpg">
                        </div>
                    </li>
                    <li>Brain damage
                        <div id="brain-damage" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Brain damage">
                            <img style="transform: translate(-45px, -50px); position: absolute;" src="assets/brain_damage.jpg">
                        </div>
                    </li>
                </ul>
                <div id="token-bin" class="flex-fill m-2 token-bin">
                    <div class="text-center"><h1>Trash tokens</h1></div>
                </div>
            </div>
        </div>
        <div id="open-resource-panel" class="btn btn-primary text-nowrap rounded-end fw-bold px-1" style="position: fixed; top: 45vh; border-radius: 0; writing-mode: vertical-lr;">
            Resource panel
        </div>
        
        <div class="flex-container">
            <div id="opponent-hand" class="player-hand"><h1 id="opponent-title" class="text-secondary p-3">Runner</h1></div>
            <div class="board"></div>
            <div id="your-hand" class="player-hand"><h1 id="your-title" class="text-secondary p-3">Corporation</h1></div>
        </div>

        <div id="open-player-panel" class="btn btn-primary text-nowrap rounded-end fw-bold px-1" style="position: fixed; top: 45vh; left: 100vw; border-radius: 0; writing-mode: vertical-lr; transform: translateX(-100%) rotate(180deg);">
            Player panel
        </div>
        <div id="player-panel" class="offcanvas offcanvas-end" style="background-color: aliceblue;" tabindex="-1">
            <div class="offcanvas-header">
                <h4 class="offcanvas-title">Player panel</h4>
            </div>
            <div class="offcanvas-body">
                <div>
                    <h5>Play as:</h5>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="player-choice" id="corp-check" value="corp">
                        <label class="form-check-label" for="corp-check">Corporation</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="player-choice" id="runner-check" value="runner">
                        <label class="form-check-label" for="runner-check">Runner</label>
                    </div>
                </div>
                <hr>
                <h5>Decklist:</h5>
                <div>
                    <div id="corp-deck">
                        <textarea id="corp-identity" rows="1" cols="35" spellcheck="false" class="mb-2" title="Corporation">Pravdivost Consulting: Political Solutions</textarea>
                        <textarea id="corp-deck-list" rows="25" cols="35" spellcheck="false">
3x Offworld Office
3x Orbital Superiority
3x Send a Message
1x Superconducting Hub
3x Nico Campaign
3x Regolith Mining License
3x Spin Doctor
3x Urtica Cipher
3x Government Subsidy
3x Hedge Fund
2x Public Trail
3x Retribution
2x Manegarm Skunkworks
3x Brân 1.0
3x Palisade
1x Ping
3x Funhouse
3x Whitespace
3x Ansel 1.0
3x Karunā
                        </textarea>
                    </div>
                    <div id="runner-deck" class="hidden">
                        <textarea id="runner-identity" rows="1" cols="35" spellcheck="false" class="mb-2" title="Runner">Nyusha "Sable" Sintashta: Symphonic Prodigy</textarea>
                        <textarea id="runner-deck-list" rows="25" cols="35" spellcheck="false">
1x Burner
3x Creative Commission
3x Diesel
3x Dirty Laundry
3x Into the Depths
3x Rigging Up
3x Sure Gamble
3x Trick Shot
3x Aniccam
1x Simulchip
1x T400 Memory Diamond
1x DJ Fenris
3x Dr. Nuka Vrolyck
1x Telework Contract
2x The Twinning
1x Afterimage
3x Hyperbaric
1x Pressure Spike
3x Mantle
1x Paricia
1x Pelangi
1x Self-modifying Code
                        </textarea>
                    </div>
                    <button id="reload-deck-button" class="btn btn-primary mt-2">Reload deck</button>
                </div>
            </div>
        </div>

    </div>
    <ul class="dropdown-menu">
        <li><h4 class="dropdown-header">Card...</h4></li>
        <li id="context-menu-flip"><a class="dropdown-item disabled">flip [double click]</a></li>
        <li id="context-menu-put-under"><a class="dropdown-item disabled">put under [MMB]</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><h4 class="dropdown-header">Deck...</h4></li>
        <li><a class="dropdown-item">shuffle in</a></li>
        <li><a class="dropdown-item">put on top</a></li>
        <li><a class="dropdown-item">put on bottom</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><h4 class="dropdown-header">Tokens...</h4></li>
        <li><a class="dropdown-item">credit</a></li>
        <li><a class="dropdown-item">advancement</a></li>
        <li><a class="dropdown-item">power</a></li>
        <li><a class="dropdown-item">virus</a></li>
        <li><a class="dropdown-item">tag</a></li>
        <li><a class="dropdown-item">bad publicity</a></li>
        <li><a class="dropdown-item">brain damage</a></li>
    </ul>
    <!-- <div class="grid-container" style="width: 100vw; height: 100vh; position: absolute; left: 0px; top: 0px;"></div> for debugging -->
    <div id="card-layer"></div>
    <div class="text-white p-1" style="position: absolute; left: 100vw; top: 100vh; transform: translate(-100%, -100%)">v0.1.14.2</div>





    <script type="module">
        document.querySelector("#play-solo").addEventListener("click", e => {
            document.querySelector("#start-game-panel").remove()
            window.playerSide = "corp"
            setupGame()
        })

        document.addEventListener("click", e => {
            document.querySelector(".dropdown-menu").style.display = "none"
        })
        document.addEventListener("auxclick", e => {
            document.querySelector(".dropdown-menu").style.display = "none"
        })

        const playerPanel = document.querySelector("#player-panel")
        document.querySelector("#open-player-panel").addEventListener("click", e => {
            playerPanel.classList.remove("hiding")
            playerPanel.classList.add("show")
            playerPanel.focus()
        })
        playerPanel.addEventListener("focusin", e => {
            playerPanel.classList.remove("hiding")
            playerPanel.classList.add("show")
        })
        playerPanel.addEventListener("focusout", e => {
            playerPanel.classList.add("hiding")
        })

        const resourcePanel = document.querySelector("#resource-panel")
        document.querySelector("#open-resource-panel").addEventListener("click", e => {
            resourcePanel.classList.remove("hiding")
            resourcePanel.classList.add("show")
            resourcePanel.focus()
        })
        resourcePanel.addEventListener("focusin", e => {
            resourcePanel.classList.remove("hiding")
            resourcePanel.classList.add("show")
        })
        resourcePanel.addEventListener("focusout", e => {
            resourcePanel.classList.add("hiding")
        })

        const flipBoard = () => {
            const documentRect = document.querySelector("body").getBoundingClientRect()
            Array.from(document.querySelectorAll("#card-layer>.deck"))
                .forEach(deck => {
                    const deckRect = deck.getBoundingClientRect()
                    deck.style.left = documentRect.width - deckRect.x + "px"
                    deck.style.top = documentRect.height - deckRect.y + "px"
                    snapToGrid(deck)
                })
            Array.from(document.querySelectorAll("#card-layer>.game-card"))
                .forEach(card => {
                    const cardRect = card.getBoundingClientRect()
                    card.style.left = documentRect.width - cardRect.x + "px"
                    card.style.top = documentRect.height - cardRect.y + "px"
                    snapToGrid(card)
                    updateCardTooltipPosition(card)
                    updateCardArea(card)
                    updateCardHoverArea(card)
                    handleCardBehavior(card)
                })
            Array.from(document.querySelectorAll("#card-layer>.token"))
                .forEach(token => {
                    const tokenRect = token.getBoundingClientRect()
                    token.style.left = documentRect.width - tokenRect.x + "px"
                    token.style.top = documentRect.height - tokenRect.y + "px"
                    snapToGrid(token, 15)
                })
        }
        document.querySelector("#corp-check").checked = "true"
        document.querySelector("#corp-check").addEventListener("click", e => {
            console.log(window.playerSide)
            if (window.playerSide !== "corp") {
                window.playerSide = "corp"
                flipBoard()
            }
            document.querySelector("#your-title").innerText = "Corporation"
            document.querySelector("#opponent-title").innerText = "Runner"

            document.querySelector("#corp-deck").classList.remove("hidden")
            document.querySelector("#runner-deck").classList.add("hidden")
        })
        document.querySelector("#runner-check").addEventListener("click", e => {
            console.log(window.playerSide)
            if (window.playerSide !== "runner") {
                window.playerSide = "runner"
                flipBoard()
            }
            document.querySelector("#your-title").innerText = "Runner"
            document.querySelector("#opponent-title").innerText = "Corporation"

            document.querySelector("#corp-deck").classList.add("hidden")
            document.querySelector("#runner-deck").classList.remove("hidden")
        })

        document.querySelector("#reload-deck-button").addEventListener("click", e => {
            document.querySelector("#card-layer").innerHTML = ""
            setupGame()
        })

        async function fetchAllCards() {
            try {
                const response = await fetch("https://netrunnerdb.com/api/2.0/public/cards");
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching:', error);
            }
        }

        const allCards = await fetchAllCards().then(cards => cards.data.map(cardIfo => {
            cardIfo.image = `https://card-images.netrunnerdb.com/v2/large/${cardIfo.code}.jpg`
            return cardIfo
        }))

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function snapToGrid(element, grid = 25) {
            const left = Math.round(element.getBoundingClientRect().x / grid) * grid
            const top = Math.round(element.getBoundingClientRect().y / grid) * grid
            element.style.left = `${left}px`;
            element.style.top = `${top}px`;
        }

        function isPointWithinElement(x, y, element) {
            const rect = element.getBoundingClientRect()
            return (
                x >= rect.left &&
                x <= rect.right &&
                y >= rect.top &&
                y <= rect.bottom
            )
        }

        const createDeck = (allCards, deckList, x, y) => {
            const deck = deckList.trim().split("\n").flatMap(entry => {
                const nameParts = entry.trim().split(" ")
                const number = parseInt(nameParts.shift().replace("x", ""))
                const name = nameParts.join(" ")

                return [...new Array(number)].map(() => name)
            }).map(cardName => allCards.find(c => c.title === cardName))
            shuffle(deck)

            const deckElement = document.createElement("div")
            deckElement.title = deck.length + " cards"
            deckElement.style.left = x
            deckElement.style.top = y
            deckElement.classList.add("deck")
            deckElement.innerHTML = `
            <div class="deck-card-back">
                <img width="190" height="265" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEArMDpLqCtEe0kLcWh5dJj0s-dAnCShz_cQ&s">
            </div>`
            document.querySelector("#card-layer").appendChild(deckElement)
            snapToGrid(deckElement)

            deckElement.addEventListener("mousedown", e => {
                e.preventDefault()

                if (deck.length) {
                    const deckRect = deckElement.getBoundingClientRect()
                    const cardElement = createCard(deck.pop(), deckRect.x + "px", deckRect.y + "px")
                    grabCard(cardElement)(e)

                    if (!deck.length) {
                        deckElement.firstElementChild.classList.add("red-tint")
                        deckElement.title = "no cards left"
                    } else {
                        deckElement.title = deck.length + " card" + (deck.length > 1 ? "s" : "")
                    }
                }
            })
            deckElement.addEventListener("puttop", e => {
                const cardInfo = cardElementToCardInfo(e.detail.card)
                deck.push(cardInfo)

                deckElement.firstElementChild.classList.remove("red-tint")
                deckElement.title = deck.length + " card" + (deck.length > 1 ? "s" : "")
            })

            deckElement.addEventListener("putbottom", e => {
                const cardInfo = cardElementToCardInfo(e.detail.card)
                deck.unshift(cardInfo)

                deckElement.firstElementChild.classList.remove("red-tint")
                deckElement.title = deck.length + " card" + (deck.length > 1 ? "s" : "")
            })

            deckElement.addEventListener("shufflein", e => {
                const cardInfo = cardElementToCardInfo(e.detail.card)
                deck.push(cardInfo)
                shuffle(deck)

                deckElement.firstElementChild.classList.remove("red-tint")
                deckElement.title = deck.length + " card" + (deck.length > 1 ? "s" : "")
            })

            deckElement.addEventListener("shuffle", e => {
                shuffle(deck)
            })

            return deckElement
        }

        const cardElementToCardInfo = (cardElement) => {
            return {
                title: cardElement.getAttribute("data-title"),
                side_code: cardElement.getAttribute("data-side"),
                faction_code: cardElement.getAttribute("data-faction"),
                type_code: cardElement.getAttribute("data-type"),
                image: cardElement.querySelector(".card-front img").src
            }
        }

        const createCard = (cardInfo, x, y) => {
            const cardElement = document.createElement("div")
            cardElement.setAttribute("data-title", cardInfo.title)
            cardElement.setAttribute("data-side", cardInfo.side_code)
            cardElement.setAttribute("data-faction", cardInfo.faction_code)
            cardElement.setAttribute("data-type", cardInfo.type_code)
            cardElement.setAttribute("data-location", "deck")
            cardElement.setAttribute("id", crypto.randomUUID())
            cardElement.style = `left: ${x}; top: ${y};`
            cardElement.classList.add("game-card")
            cardElement.innerHTML = `
            <div class="card-front">
                <img width="190" height="265" src="${cardInfo.image}">
            </div>
            <div class="card-back">
                <img width="190" height="265" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEArMDpLqCtEe0kLcWh5dJj0s-dAnCShz_cQ&s">
            </div>
            <div class="game-card-tooltip">
                <img width="190" height="265" src="${cardInfo.image}">
            </div>
            `
            document.querySelector("#card-layer").appendChild(cardElement)

            cardElement.addEventListener("mousedown", grabCard(cardElement))
            cardElement.addEventListener("dblclick", flipCard(cardElement))
            cardElement.addEventListener("auxclick", putCardUnder(cardElement))
            cardElement.addEventListener("contextmenu", cardContextMenu(cardElement))
            cardElement.addEventListener("grab", e => {
                updateCardOrder(cardElement)
            })
            cardElement.addEventListener("move", e => {
                updateCardTooltipPosition(cardElement)
                updateCardHoverArea(cardElement)
            })
            cardElement.addEventListener("ungrab", e => {
                updateCardOrder(cardElement)
                snapToGrid(cardElement)
                updateCardArea(cardElement)
                handleCardBehavior(cardElement)
                
                const cardRect = cardElement.getBoundingClientRect()
                const targetDeck = Array.from(document.querySelectorAll(".deck")).find(deck => isPointWithinElement(cardRect.x, cardRect.y, deck.firstElementChild))
                if (targetDeck) {
                    const putTop = new CustomEvent("puttop", {detail: {card: cardElement}})
                    targetDeck.dispatchEvent(putTop)
                    cardElement.remove()
                }
            })
            snapToGrid(cardElement)
            updateCardTooltipPosition(cardElement)
            handleCardBehavior(cardElement)
            return cardElement
        }

        const flipCard = (element) => {
            return () => {
                element.classList.toggle("flipped")
            }
        }

        const putCardUnder = (element) => {
            return e => {
                e.preventDefault()

                if (e.button === 1) {
                    const cardLayer = document.querySelector("#card-layer")
                    cardLayer.insertBefore(element, cardLayer.firstElementChild)
                }
            }
        }

        const cardContextMenu = (element) => {
            return e => {
                e.preventDefault()
                const contextMenu = document.querySelector(".dropdown-menu")
                const newContextMenu = contextMenu.cloneNode(true)
                contextMenu.parentNode.replaceChild(newContextMenu, contextMenu)

                newContextMenu.style.display = "block"
                newContextMenu.style.left = e.clientX + "px"
                newContextMenu.style.top = e.clientY + "px"
                newContextMenu.scrollIntoView()
                // newContextMenu.querySelector("#context-menu-flip").addEventListener("click", flipCard(element))
                // newContextMenu.querySelector("#context-menu-put-under").addEventListener("click", putCardUnder(element))
                // newContextMenu.querySelector("#context-menu-rotate").addEventListener("click", () => element.classList.toggle("rotated"))
            }
        }

        const grabCard = (element) => {
            const grab = e => {
                if (e.button === 0) {
                    e.preventDefault()
                    e.stopPropagation()

                    const elementRect = element.getBoundingClientRect()
                    const offsetX = elementRect.x - e.clientX
                    const offsetY = elementRect.y - e.clientY

                    const thisMove = move(offsetX, offsetY)
                    const thisUngrab = ungrab(thisMove)
                    document.querySelector("body").addEventListener("mousemove", thisMove)
                    document.querySelector("body").addEventListener("mouseup", thisUngrab)

                    element.dispatchEvent(new CustomEvent("grab", {detail: {targetX: elementRect.x, targetY: elementRect.y}}))
                }
            }

            const move = (offsetX, offsetY) => e => {
                e.preventDefault()
                e.stopPropagation()

                element.style.left = e.clientX + offsetX + "px"
                element.style.top = e.clientY + offsetY + "px"

                element.dispatchEvent(new CustomEvent("move", {detail: {targetX: e.clientX + offsetX, targetY: e.clientY + offsetY}}))
            }

            const ungrab = (thisMove) => {
                const thisUngrab = e => {
                    e.preventDefault()
                    e.stopPropagation()
                    document.querySelector("body").removeEventListener("mousemove", thisMove)
                    document.querySelector("body").removeEventListener("mouseup", thisUngrab)

                    const elementRect = element.getBoundingClientRect()
                    element.dispatchEvent(new CustomEvent("ungrab", {detail: {targetX: elementRect.x, targetY: elementRect.y}}))
                }
                return thisUngrab
            }

            return grab
        }

        const updateCardOrder = (cardElement) => {
            const cardLayer = document.querySelector("#card-layer")
            if (cardLayer.lastElementChild !== cardElement) {
                cardLayer.appendChild(cardElement)
                cardElement.click()
            }
        }

        const updateCardTooltipPosition = (cardElement) => {
            const y = cardElement.getBoundingClientRect().y
            if (y < 500) {
                cardElement.querySelector(".game-card-tooltip").classList.add("force-in-view")
            } else {
                cardElement.querySelector(".game-card-tooltip").classList.remove("force-in-view")
            }
        }

        const updateCardHoverArea = (cardElement) => {
            const cardRect = cardElement.getBoundingClientRect()
            const handHeight = document.querySelector("#your-hand").getBoundingClientRect().height - 10 //protection from play by grid snapping
            const decks = [...document.querySelectorAll(".deck")]

            if (decks.some(deck => isPointWithinElement(cardRect.x, cardRect.y, deck.firstElementChild))) {
                cardElement.setAttribute("data-hover-location", "deck")
            } else if (cardRect.y > (document.documentElement.clientHeight - handHeight)) {
                cardElement.setAttribute("data-hover-location", "hand")
            } else if (cardRect.y < handHeight) {
                cardElement.setAttribute("data-hover-location", "opponent-hand")
            } else {
                cardElement.setAttribute("data-hover-location", "board")
            }
        }

        const updateCardArea = (cardElement) => {
            const cardRect = cardElement.getBoundingClientRect()
            const handHeight = document.querySelector("#your-hand").getBoundingClientRect().height - 10 //protection from play by grid snapping
            const decks = [...document.querySelectorAll(".deck")]

            if (decks.some(deck => isPointWithinElement(cardRect.x, cardRect.y, deck.firstElementChild))) {
                cardElement.setAttribute("data-location", "deck")
            } else if (cardRect.y > (document.documentElement.clientHeight - handHeight)) {
                cardElement.setAttribute("data-location", "hand")
            } else if (cardRect.y < handHeight) {
                cardElement.setAttribute("data-location", "opponent-hand")
            } else {
                cardElement.setAttribute("data-location", "board")
            }
        }

        const handleCardBehavior = (cardElement) => {
            const cardLocation = cardElement.getAttribute("data-location")

            switch (cardLocation) {
                case "deck":
                    if (cardElement.getAttribute("data-type") === "identity") {
                        cardElement.setAttribute("data-location", "board")
                        cardVisibility(cardElement, true, false, true)
                    } else {
                        cardVisibility(cardElement, false, true, false)
                    }
                    break

                case "hand":
                    cardElement.classList.remove("flipped")
                    cardVisibility(cardElement, true, false, true)
                    const yourHandRect = document.querySelector("#your-hand").getBoundingClientRect()
                    cardElement.style.top = yourHandRect.y + yourHandRect.height / 2 + "px"
                    snapToGrid(cardElement)
                    break

                case "opponent-hand":
                    cardElement.classList.remove("flipped")
                    cardVisibility(cardElement, false, true, false)
                    break

                case "board":
                    if (cardElement.getAttribute("data-side") === "corp") {
                        if (cardElement.getAttribute("data-type") === "operation" || cardElement.getAttribute("data-type") === "identity") {
                            cardVisibility(cardElement, true, false, true)
                        } else {
                            if (cardElement.getAttribute("data-side") === window.playerSide) {
                                cardVisibility(cardElement, false, true, true)
                            } else {
                                cardVisibility(cardElement, false, true, false)
                            }
                        }
                    } else {
                        cardVisibility(cardElement, true, false, true)
                    }
                    const yourHandY = document.querySelector("#your-hand").getBoundingClientRect().y
                    const cardY = cardElement.getBoundingClientRect().y
                    if (yourHandY - cardY < 75) {
                        cardElement.style.top = cardY - (75 - (yourHandY - cardY)) + "px"
                        snapToGrid(cardElement)
                    }
                    break

                case "bin":
                    cardVisibility(cardElement, true, false, true)
                    break
            }

            if (cardElement.getAttribute("data-type") === "ice" && cardLocation === "board") {
                cardElement.classList.add("rotated")
            } else {
                cardElement.classList.remove("rotated")
            }
        }

        function cardVisibility(cardElement, frontVisible, backVisible, tooltipVisible) {
            if (frontVisible) {
                cardElement.querySelector(".card-front").classList.remove("hidden")
            } else {
                cardElement.querySelector(".card-front").classList.add("hidden")
            }
            if (backVisible) {
                cardElement.querySelector(".card-back").classList.remove("hidden")
            } else {
                cardElement.querySelector(".card-back").classList.add("hidden")
            }
            if (tooltipVisible) {
                cardElement.querySelector(".game-card-tooltip").classList.remove("hidden")
            } else {
                cardElement.querySelector(".game-card-tooltip").classList.add("hidden")
            }
        }

        const createToken = (tokenName, x, y) => {
            const tokenElement = document.createElement("div")

            const innerElement = document.querySelector("#" + tokenName).cloneNode(true)
            innerElement.style.position = "absolute";
            innerElement.style.transform += "translate(-50%, -50%) translate(-10px, -10px)"
            tokenElement.appendChild(innerElement)

            tokenElement.id = crypto.randomUUID()
            tokenElement.classList.add("token")
            tokenElement.style.left = x
            tokenElement.style.top = y
            tokenElement.addEventListener("mousedown", grabCard(tokenElement))
            tokenElement.addEventListener("grab", e => {
                updateCardOrder(tokenElement)
                tokenElement.style.left = e.detail.targetX + "px"
                tokenElement.style.top = e.detail.targetY + "px"
            })
            tokenElement.addEventListener("move", e => {
                tryActivateBin(e)
            })
            tokenElement.addEventListener("ungrab", e => {
                updateCardOrder(tokenElement)
                snapToGrid(tokenElement, 15)
                const tokenRect = tokenElement.getBoundingClientRect()

                const tokenBin = document.querySelector("#token-bin")
                if (isPointWithinElement(tokenRect.x, tokenRect.y, tokenBin)) {
                    tokenElement.remove()
                    tokenBin.classList.remove("token-bin-active")
                } else {
                    tryPutTokenOnCard(tokenElement, tokenRect)
                    tryPutTokenOnToken(tokenElement, tokenRect)
                }
            })

            const dualTokens = [
                ["credit", "advancement"],
                ["advancement", "credit"],
                ["power", "virus"],
                ["virus", "power"],
                ["tag", "bad-publicity"],
                ["bad-publicity", "tag"]
            ]
            dualTokens.filter(([key, value]) => key === tokenName).forEach(([key, value]) => {
                tokenElement.addEventListener("dblclick", e => {
                    e.preventDefault()
                    e.stopPropagation()
                    
                    flipToken(tokenElement, key, value)
                })
            })
            tokenElement.addEventListener("auxclick", e => {
                e.preventDefault()
                e.stopPropagation()

                if (e.button === 1) {
                    const lastTokenInStack = tokenElement.querySelector("div:only-child").parentElement
                    lastTokenInStack.appendChild(createToken(tokenElement.firstElementChild.id, "0px", "15px"))
                }
            })
            document.querySelector("#card-layer").appendChild(tokenElement)
            return tokenElement
        }

        function tryActivateBin(moveEvent) {
            const tokenBin = document.querySelector("#token-bin")
            if (isPointWithinElement(moveEvent.detail.targetX, moveEvent.detail.targetY, tokenBin)) {
                tokenBin.classList.add("token-bin-active")
            } else {
                tokenBin.classList.remove("token-bin-active")
            }
        }

        function tryPutTokenOnCard(tokenElement, tokenRect) {
            const cards = [...document.querySelectorAll(".game-card")]
            cards.forEach(card => {
                if (isPointWithinElement(tokenRect.x, tokenRect.y, [...card.children].find(child => getComputedStyle(child).display !== "none"))) {
                    card.appendChild(tokenElement)
                    const cardRect = card.getBoundingClientRect()
                    if (card.classList.contains("rotated")) {
                        tokenElement.style.left = (tokenRect.y - cardRect.y) * 2 + "px"
                        tokenElement.style.top = -(tokenRect.x - cardRect.x) * 2 + "px"
                    } else {
                        tokenElement.style.left = (tokenRect.x - cardRect.x) * 2 + "px"
                        tokenElement.style.top = (tokenRect.y - cardRect.y) * 2 + "px"
                    }
                }
            })
        }
        
        function tryPutTokenOnToken(tokenElement, tokenRect) {
            const tokens = [...document.querySelectorAll(`.token`)].filter(t => t.id !== tokenElement.id && !tokenElement.contains(t))
            tokens.forEach(token => {
                if (isPointWithinElement(tokenRect.x, tokenRect.y, token.firstElementChild)) {
                    token.appendChild(tokenElement)
                    tokenElement.style.left = "0px"
                    tokenElement.style.top = "15px"
                }
            })
        }
        
        function flipToken(tokenElement, key, value) {
            const newTokenName = tokenElement.firstElementChild.id === key ? value : tokenElement.firstElementChild.id === value ? key : tokenElement.firstElementChild.id
            const newInnerElement = document.querySelector("#" + newTokenName).cloneNode(true)
            newInnerElement.style.position = "absolute";
            newInnerElement.style.transform += "translate(-50%, -50%) translate(-10px, -10px)"
            tokenElement.replaceChild(newInnerElement, tokenElement.firstElementChild)

            const stactedToken = tokenElement.querySelector(".token")
            if (stactedToken) {
                flipToken(stactedToken, key, value)
            }
        }

        ["credit", "advancement", "power", "virus", "tag", "bad-publicity", "brain-damage"].forEach(tokenName => {
            document.querySelector("#" + tokenName).addEventListener("mousedown", e => {
                e.preventDefault()

                const tokenElement = createToken(tokenName, e.clientX + "px", e.clientY + "px")
                grabCard(tokenElement)(e)
            })
        })

        const setupGame = () => {
            const corpDeckLocation = window.playerSide === "corp" ? ["85vw", "75vh"] : ["15vw", "25vh"]
            const corpIdentityLocation = window.playerSide === "corp" ? ["75vw", "75vh"] : ["25vw", "25vh"]

            createDeck(allCards, document.querySelector("#corp-deck-list").value, ...corpDeckLocation)
            const corpIndentity = document.querySelector("#corp-identity").value.trim()
            const corpIndentityElement = createCard(allCards.find(cardInfo => cardInfo.title === corpIndentity), ...corpIdentityLocation)

            const runnerDeckLocation = window.playerSide === "corp" ? ["15vw", "25vh"] : ["85vw", "75vh"]
            const runnerIndentityLocation = window.playerSide === "corp" ? ["25vw", "25vh"] : ["75vw", "75vh"]

            createDeck(allCards, document.querySelector("#runner-deck-list").value, ...runnerDeckLocation)
            const runnerIndentity = document.querySelector("#runner-identity").value.trim()
            const runnerIndentityElement = createCard(allCards.find(cardInfo => cardInfo.title === runnerIndentity), ...runnerIndentityLocation)
        }
        // setupGame()
    </script>





    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        .flex-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        .player-hand {
            height: 150px;
            background-color: lightskyblue;
        }
        .board {
            flex-grow: 1;
            background-color: lightblue;
        }

        .deck {
            position: absolute;
            transform: translate(-50%, -50%) scale(.5);
        }
        .deck-card-back {
            position: absolute;
            transform: translate(-50%, -50%) translate(-5px, 5px);
            padding-left: 10px;
            padding-bottom: 10px;
            border: 5px solid black;
            border-radius: 11px;
            border-top-left-radius: 25px;
            border-bottom-right-radius: 25px;
            overflow: hidden;
            background-color: black;
        }
        .red-tint::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.5);
            mix-blend-mode: multiply;
        }

        .game-card {
            position: absolute;
            transform: translate(-50%, -50%) scale(.5);
            z-index: 1;
        }
        .game-card:hover {
            z-index: 20;
        }
        .card-front {
            transform: translate(-50%, -50%);
            border: 3px solid black;
            border-radius: 11px;
            background-color: black;
            overflow: hidden;
            position: absolute;
        }
        .card-back {
            transform: translate(-50%, -50%);
            border: 3px solid black;
            border-radius: 11px;
            background-color: black;
            overflow: hidden;
            position: absolute;
        }

        .game-card-tooltip {
            border: 3px solid black;
            border-radius: 11px;
            background-color: black;
            overflow: hidden;
            position: absolute;
            visibility: hidden;
            transform: scale(3.1415) translate(-30px, -230px) var(--force-in-view);
            
            z-index: 3099;
        }

        .game-card:hover .game-card-tooltip {
            visibility: visible;
        }

        .hidden {
            display: none;
        }
        .flipped>:not(.hidden) {
            display: none;
        }
        .flipped>.hidden {
            display: block;
        }
        .flipped>.card-front.hidden~.game-card-tooltip:not(.hidden) {
            display: block;
        }

        .game-card.rotated {
            transform: translate(-50%, -50%) scale(.5) rotate(90deg);
        }
        .rotated .game-card-tooltip {
            transform: rotate(-90deg) scale(3.1415) translate(45px, -210px) var(--force-in-view);
        }

        .token {
            position: absolute;
            z-index: 20;
            display: block !important;
        }
        .game-card>.token {
            transform: scale(2) translate(50%, 50%);
        }
        .game-card.rotated>.token {
            transform: rotate(-90deg) scale(2) translate(50%, 50%);
        }
        .token:hover {
            z-index: 25;
        }
        .token-bin {
            border: 1px lightgrey dashed;
            border-radius: 15px;
            border-width: 3px;
            color: lightgrey;
        }
        .token-bin-active {
            color: red;
            border-color: red;
        }

        .game-card[data-location="hand"]:not([data-hover-location="hand"])>* {
            box-shadow:
                0 0 5px rgba(165, 255, 47, 0.5),
                0 0 10px rgba(165, 255, 47, 0.5),
                0 0 20px rgba(165, 255, 47, 0.5),
                0 0 30px rgba(165, 255, 47, 0.5),
                0 0 40px rgba(165, 255, 47, 0.5);
        }
        .game-card:not([data-location="hand"])[data-hover-location="hand"]>* {
            box-shadow:
                0 0 5px rgba(255, 165, 0, 0.5),
                0 0 10px rgba(255, 165, 0, 0.5),
                0 0 20px rgba(255, 165, 0, 0.5),
                0 0 30px rgba(255, 165, 0, 0.5),
                0 0 40px rgba(255, 165, 0, 0.5);
        }
        .game-card:not([data-location="deck"])[data-hover-location="deck"]>* {
            box-shadow:
                0 0 5px rgba(0, 191, 255, 0.5),
                0 0 10px rgb(0, 191, 255, 0.5),
                0 0 20px rgba(0, 191, 255, 0.5),
                0 0 30px rgba(0, 191, 255, 0.5),
                0 0 40px rgba(0, 191, 255, 0.5);
        }

        .game-card[data-location="board"]>* {
            animation: glow-impulse 1s normal;
        }

        @keyframes glow-impulse {
            0% {
                box-shadow:
                0 0 5px rgba(255, 255, 255, 0),
                0 0 10px rgba(255, 255, 255, 0),
                0 0 20px rgba(255, 255, 255, 0),
                0 0 30px rgba(255, 255, 255, 0),
                0 0 40px rgba(255, 255, 255, 0);
            }
            5% {
                box-shadow:
                0 0 5px rgba(255, 255, 255, 1),
                0 0 10px rgba(255, 255, 255, 1),
                0 0 20px rgba(255, 255, 255, 1),
                0 0 30px rgba(255, 255, 255, 1),
                0 0 40px rgba(255, 255, 255, 1);
            }
            100% {
                box-shadow:
                0 0 5px rgba(255, 255, 255, 0),
                0 0 10px rgba(255, 255, 255, 0),
                0 0 20px rgba(255, 255, 255, 0),
                0 0 30px rgba(255, 255, 255, 0),
                0 0 40px rgba(255, 255, 255, 0);
            }
        }

        :root {
            --force-in-view: translate(0px, 0px);
        }

        .force-in-view {
            --force-in-view: translate(0px, 375px);
        }

        .grid-container {
            width: 100%;
            height: 100vh;
            background-image: 
                linear-gradient(to right, lightgray 1px, transparent 1px),
                linear-gradient(to bottom, lightgray 1px, transparent 1px);
            background-size: 25px 25px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</body>

</html>