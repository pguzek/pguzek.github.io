<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netrunner</title>
    <div style="display: none;">
        TODO:
        - deck cotaining cards
        - token context menu
        - card context menu
        - add custom events for grab, move, ungrab
        - select oldest card art, lowest id?
    </div>
</head>

<body>
    <div>
        <div id="resource-panel" class="offcanvas offcanvas-start" style="width: 250px; background-color: aliceblue; z-index: 15;" tabindex="-1">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title">Resource panel</h5>
            </div>
            <div class="offcanvas-body d-flex flex-column align-items-center">
                <ul>
                    <li>Credit
                        <div id="credit" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Credit / Advancement">
                            <img style="transform: translate(-45px, -50px);" src="assets/credit.jpg">
                        </div>
                    </li>
                    <li>Advancement
                        <div id="advancement" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 256px; height: 256px; transform: scale(0.171875); margin: -104px;" title="Advancement / Credit">
                            <img style="transform: translate(-4px, -5px);" src="assets/click.jpg">
                        </div>
                    </li>
                    <li>Power
                        <div id="power" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Power / Virus">
                            <img style="transform: translateX(-256px) translate(-45px, -47px);" src="assets/virus.jpg">
                        </div>
                    </li>
                    <li>Virus
                        <div id="virus" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Virus / Power">
                            <img style="transform: translate(-45px, -47px);" src="assets/virus.jpg">
                        </div>
                    </li>
                    <li>Tag
                        <div id="tag" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Tag / Bad publicity">
                            <img style="transform: translate(-45px, -50px);" src="assets/tag.jpg">
                        </div>
                    </li>
                    <li>Bad publicity
                        <div id="bad-publicity" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Bad publicity / Tag">
                            <img style="transform: translate(-40px, -45px);" src="assets/bad_publicity.jpg">
                        </div>
                    </li>
                    <li>Brain damage
                        <div id="brain-damage" class="border border-5 border-black rounded-circle" style="overflow: hidden; width: 176px; height: 176px; transform: scale(.25); margin: -64px;" title="Brain damage">
                            <img style="transform: translate(-45px, -50px); position: absolute;" src="assets/brain_damage.jpg">
                        </div>
                    </li>
                </ul>
                <div id="token-bin" class="flex-fill m-2 token-bin">
                    <div class="text-center"><h1>Trash tokens</h1></div>
                </div>
            </div>
        </div>
        <div id="open-resource-panel" class="btn btn-primary rounded-end fw-bold px-1"  style="position: fixed; top: 45vh; border-radius: 0; writing-mode: vertical-lr;">Resource panel</div>
        
        <div class="flex-container">
            <div id="opponent-hand" class="player-hand"><h1 id="opponent-title" class="text-secondary p-3">Runner</h1></div>
            <div class="board"></div>
            <div id="your-hand" class="player-hand"><h1 id="your-title" class="text-secondary p-3">Corporation</h1></div>
        </div>

        <div id="open-player-panel" class="btn btn-primary rounded-start fw-bold px-1" style="position: fixed; top: 45vh; left: 100vw; border-radius: 0; writing-mode: sideways-lr; transform: translateX(-100%);">Player panel</div>
        <div id="player-panel" class="offcanvas offcanvas-end" style="background-color: aliceblue;" tabindex="-1">
            <div class="offcanvas-header">
                <h4 class="offcanvas-title">Player panel</h4>
            </div>
            <div class="offcanvas-body">
                <div>
                    <h5>Play as:</h5>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="player-choice" id="corp-check" value="corp">
                        <label class="form-check-label" for="corp-check">Corporation</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="player-choice" id="runner-check" value="runner">
                        <label class="form-check-label" for="runner-check">Runner</label>
                    </div>
                </div>
                <hr>
                <h5>Decklist:</h5>
                <div>
                    <div id="corp-deck">
                        <textarea id="corp-identity" rows="1" cols="30" spellcheck="false" class="mb-2" title="Corporation">Pravdivost Consulting: Political Solutions</textarea>
                        <textarea id="corp-deck-list" rows="25" cols="30" spellcheck="false">
3x Offworld Office
3x Orbital Superiority
3x Send a Message
1x Superconducting Hub
3x Nico Campaign
3x Regolith Mining License
3x Spin Doctor
3x Urtica Cipher
3x Government Subsidy
3x Hedge Fund
2x Public Trail
3x Retribution
2x Manegarm Skunkworks
3x Brân 1.0
3x Palisade
1x Ping
3x Funhouse
3x Whitespace
3x Ansel 1.0
3x Karunā
                        </textarea>
                    </div>
                    <div id="runner-deck" class="hidden">
                        <textarea id="runner-identity" rows="1" cols="30" spellcheck="false" class="mb-2" title="Runner">Nyusha "Sable" Sintashta: Symphonic Prodigy</textarea>
                        <textarea id="runner-deck-list" rows="25" cols="30" spellcheck="false">
1x Burner
3x Creative Commission
3x Diesel
3x Dirty Laundry
3x Into the Depths
3x Rigging Up
3x Sure Gamble
3x Trick Shot
3x Aniccam
1x Simulchip
1x T400 Memory Diamond
1x DJ Fenris
3x Dr. Nuka Vrolyck
1x Telework Contract
2x The Twinning
1x Afterimage
3x Hyperbaric
1x Pressure Spike
3x Mantle
1x Paricia
1x Pelangi
1x Self-modifying Code
                        </textarea>
                    </div>
                    <button id="reload-deck-button" class="btn btn-primary mt-2">Reload deck</button>
                </div>
            </div>
        </div>

    </div>
    <ul class="dropdown-menu">
        <li><h4 class="dropdown-header">Card...</h4></li>
        <li id="context-menu-flip"><a class="dropdown-item disabled">flip [double click]</a></li>
        <li id="context-menu-put-under"><a class="dropdown-item disabled">put under [MMB]</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><h4 class="dropdown-header">Deck...</h4></li>
        <li><a class="dropdown-item">shuffle in</a></li>
        <li><a class="dropdown-item">put on top</a></li>
        <li><a class="dropdown-item">put on bottom</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><h4 class="dropdown-header">Tokens...</h4></li>
        <li><a class="dropdown-item">credit</a></li>
        <li><a class="dropdown-item">advancement</a></li>
        <li><a class="dropdown-item">power</a></li>
        <li><a class="dropdown-item">virus</a></li>
        <li><a class="dropdown-item">tag</a></li>
        <li><a class="dropdown-item">bad publicity</a></li>
        <li><a class="dropdown-item">brain damage</a></li>
    </ul>
    <!-- <div class="grid-container" style="width: 100vw; height: 100vh; position: absolute; left: 0px; top: 0px;"></div> for debugging -->
    <div id="card-layer"></div>





    <script type="module">
        window.playerSide = "corp"

        document.addEventListener("click", e => {
            document.querySelector(".dropdown-menu").style.display = "none"
        })
        document.addEventListener("auxclick", e => {
            document.querySelector(".dropdown-menu").style.display = "none"
        })

        const playerPanel = document.querySelector("#player-panel")
        document.querySelector("#open-player-panel").addEventListener("click", e => {
            playerPanel.classList.remove("hiding")
            playerPanel.classList.add("show")
            playerPanel.focus()
        })
        playerPanel.addEventListener("focusin", e => {
            playerPanel.classList.remove("hiding")
            playerPanel.classList.add("show")
        })
        playerPanel.addEventListener("focusout", e => {
            playerPanel.classList.add("hiding")
        })

        const resourcePanel = document.querySelector("#resource-panel")
        document.querySelector("#open-resource-panel").addEventListener("click", e => {
            resourcePanel.classList.remove("hiding")
            resourcePanel.classList.add("show")
            resourcePanel.focus()
        })
        resourcePanel.addEventListener("focusin", e => {
            resourcePanel.classList.remove("hiding")
            resourcePanel.classList.add("show")
        })
        resourcePanel.addEventListener("focusout", e => {
            resourcePanel.classList.add("hiding")
        })

        const flipBoard = () => {
            [...document.querySelectorAll("#card-layer>.game-card")]
                .forEach(card => {
                    card.style.left = document.querySelector("body").getBoundingClientRect().width - card.getBoundingClientRect().x + "px"
                    card.style.top = document.querySelector("body").getBoundingClientRect().height - card.getBoundingClientRect().y + "px"
                    snapToGrid(card)
                    updateCardTooltipPosition(card)
                    updateCardArea(card)
                    updateCardHoverArea(card)
                    handleCardBehavior(card)
                });
            [...document.querySelectorAll("#card-layer>.token")]
                .forEach(token => {
                    token.style.left = document.querySelector("body").getBoundingClientRect().width - token.getBoundingClientRect().x + "px"
                    token.style.top = document.querySelector("body").getBoundingClientRect().height - token.getBoundingClientRect().y + "px"
                    snapToGrid(token, 15)
                })
        }
        document.querySelector("#corp-check").checked = "true"
        document.querySelector("#corp-check").addEventListener("click", e => {
            console.log(window.playerSide)
            if (window.playerSide !== "corp") {
                window.playerSide = "corp"
                flipBoard()
            }
            document.querySelector("#your-title").innerText = "Corporation"
            document.querySelector("#opponent-title").innerText = "Runner"

            document.querySelector("#corp-deck").classList.remove("hidden")
            document.querySelector("#runner-deck").classList.add("hidden")
        })
        document.querySelector("#runner-check").addEventListener("click", e => {
            console.log(window.playerSide)
            if (window.playerSide !== "runner") {
                window.playerSide = "runner"
                flipBoard()
            }
            document.querySelector("#your-title").innerText = "Runner"
            document.querySelector("#opponent-title").innerText = "Corporation"

            document.querySelector("#corp-deck").classList.add("hidden")
            document.querySelector("#runner-deck").classList.remove("hidden")
        })

        document.querySelector("#reload-deck-button").addEventListener("click", e => {
            document.querySelector("#card-layer").innerHTML = ""
            setupGame()
        })

        async function fetchAllCards() {
            try {
                const response = await fetch("https://netrunnerdb.com/api/2.0/public/cards");
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error fetching:', error);
            }
        }

        const allCards = await fetchAllCards().then(cards => cards.data.map(cardIfo => {
            cardIfo.image = `https://card-images.netrunnerdb.com/v2/large/${cardIfo.code}.jpg`
            return cardIfo
        }))

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function snapToGrid(element, grid = 25) {
            const left = Math.round(element.getBoundingClientRect().x / grid) * grid
            const top = Math.round(element.getBoundingClientRect().y / grid) * grid
            element.style.left = `${left}px`;
            element.style.top = `${top}px`;
        }

        function isPointWithinElement(x, y, element) {
            const rect = element.getBoundingClientRect();
            return (
                x >= rect.left &&
                x <= rect.right &&
                y >= rect.top &&
                y <= rect.bottom
            )
        }

        const createDeck = (allCards, deckList, x, y) => {
            const deckElement = document.createElement("div")
            deckElement.title = "draw a card"
            deckElement.style.left = x
            deckElement.style.top = y
            deckElement.classList.add("deck")
            deckElement.innerHTML = `
            <div class="deck-card-back">
                <img width="190" height="265" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEArMDpLqCtEe0kLcWh5dJj0s-dAnCShz_cQ&s">
            </div>`
            document.querySelector("#card-layer").appendChild(deckElement)

            const deck = deckList.trim().split("\n").flatMap(entry => {
                const nameParts = entry.trim().split(" ")
                const number = parseInt(nameParts.shift().replace("x", ""))
                const name = nameParts.join(" ")

                return [...new Array(number)].map(() => name)
            }).map(cardName => allCards.find(c => c.title === cardName))

            shuffle(deck)
            deck.forEach(cardInfo => createCard(cardInfo, x, y))
            snapToGrid(deckElement)
            return deckElement
        }

        const createCard = (cardInfo, x, y) => {
            const cardElement = document.createElement("div")
            cardElement.setAttribute("data-title", cardInfo.title)
            cardElement.setAttribute("data-side", cardInfo.side_code)
            cardElement.setAttribute("data-faction", cardInfo.faction_code)
            cardElement.setAttribute("data-type", cardInfo.type_code)
            cardElement.setAttribute("data-location", "deck")
            cardElement.setAttribute("id", crypto.randomUUID())
            cardElement.style = `left: ${x}; top: ${y};`
            cardElement.classList.add("game-card")
            cardElement.innerHTML = `
            <div class="card-front">
                <img width="190" height="265" src="${cardInfo.image}">
            </div>
            <div class="card-back">
                <img width="190" height="265" src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEArMDpLqCtEe0kLcWh5dJj0s-dAnCShz_cQ&s">
            </div>
            <div class="game-card-tooltip">
                <img width="190" height="265" src="${cardInfo.image}">
            </div>
            `
            document.querySelector("#card-layer").appendChild(cardElement)

            cardElement.addEventListener("mousedown", grabCard(cardElement))
            cardElement.addEventListener("dblclick", flipCard(cardElement))
            cardElement.addEventListener("auxclick", putCardUnder(cardElement))
            cardElement.addEventListener("contextmenu", cardContextMenu(cardElement))
            snapToGrid(cardElement)
            updateCardTooltipPosition(cardElement)
            handleCardBehavior(cardElement)
            return cardElement
        }

        const flipCard = (element) => {
            return () => {
                element.classList.toggle("flipped")
            }
        }

        const putCardUnder = (element) => {
            return e => {
                if (e.button === 1) {
                    const cardLayer = document.querySelector("#card-layer")
                    cardLayer.insertBefore(element, cardLayer.firstElementChild)
                }
            }
        }

        const cardContextMenu = (element) => {
            return e => {
                e.preventDefault()
                const contextMenu = document.querySelector(".dropdown-menu")
                const newContextMenu = contextMenu.cloneNode(true)
                contextMenu.parentNode.replaceChild(newContextMenu, contextMenu)

                newContextMenu.style.display = "block"
                newContextMenu.style.left = e.clientX + "px"
                newContextMenu.style.top = e.clientY + "px"
                newContextMenu.scrollIntoView()
                // newContextMenu.querySelector("#context-menu-flip").addEventListener("click", flipCard(element))
                // newContextMenu.querySelector("#context-menu-put-under").addEventListener("click", putCardUnder(element))
                // newContextMenu.querySelector("#context-menu-rotate").addEventListener("click", () => element.classList.toggle("rotated"))
            }
        }

        const grabCard = (element) => {
            const grab = e => {
                if (e.button === 0) {
                    e.preventDefault()
                    e.stopPropagation()

                    const elementRect = element.getBoundingClientRect()
                    const offsetX = elementRect.x - e.clientX
                    const offsetY = elementRect.y - e.clientY

                    const thisMove = move(offsetX, offsetY)
                    const thisUngrab = ungrab(thisMove)
                    document.querySelector("body").addEventListener("mousemove", thisMove)
                    document.querySelector("body").addEventListener("mouseup", thisUngrab)

                    if (element.classList.contains("token")) {
                        updateCardOrder(element)
                        element.style.left = elementRect.x + "px"
                        element.style.top = elementRect.y + "px"
                    }
                }
            }

            const move = (offsetX, offsetY) => e => {
                e.preventDefault()
                e.stopPropagation()

                element.style.left = e.clientX + offsetX + "px"
                element.style.top = e.clientY + offsetY + "px"

                if (element.classList.contains("game-card")) { //TODO
                    updateCardTooltipPosition(element)
                    updateCardHoverArea(element)
                } else if (element.classList.contains("token")) {
                    const tokenBin = document.querySelector("#token-bin")
                    if (isPointWithinElement(e.clientX + offsetX, e.clientY + offsetY, tokenBin)) {
                        tokenBin.classList.add("token-bin-active")
                    } else {
                        tokenBin.classList.remove("token-bin-active")
                    }
                }
            }

            const ungrab = (thisMove) => {
                const thisUngrab = e => {
                    e.preventDefault()
                    e.stopPropagation()
                    document.querySelector("body").removeEventListener("mousemove", thisMove)
                    document.querySelector("body").removeEventListener("mouseup", thisUngrab)

                    updateCardOrder(element)
                    if (element.classList.contains("game-card")) { //TODO
                        snapToGrid(element)
                        updateCardArea(element)
                        handleCardBehavior(element)
                    } else if (element.classList.contains("token")) {
                        snapToGrid(element, 15)
                        const tokenBin = document.querySelector("#token-bin")
                        const rect = element.getBoundingClientRect()
                        if (isPointWithinElement(rect.x, rect.y, tokenBin)) {
                            element.remove()
                            tokenBin.classList.remove("token-bin-active")
                        } else {
                            const cards = [...document.querySelectorAll(".game-card")]
                            cards.forEach(card => {
                                if (isPointWithinElement(rect.x, rect.y, [...card.children].find(child => getComputedStyle(child).display !== "none"))) {
                                    card.append(element)
                                    const cardRect = card.getBoundingClientRect()
                                    if (card.classList.contains("rotated")) {
                                        element.style.left = (rect.y - cardRect.y) * 2 + "px"
                                        element.style.top = -(rect.x - cardRect.x) * 2 + "px"
                                    } else {
                                        element.style.left = (rect.x - cardRect.x) * 2 + "px"
                                        element.style.top = (rect.y - cardRect.y) * 2 + "px"
                                    }
                                }
                            })
                            const tokens = [...document.querySelectorAll(`.token`)].filter(t => t.id !== element.id && !element.contains(t))
                            tokens.forEach(token => {
                                if (isPointWithinElement(rect.x, rect.y, token.firstElementChild)) {
                                    token.append(element)
                                    element.style.left = "0px"
                                    element.style.top = "15px"
                                }
                            })
                        }
                    }
                }
                return thisUngrab
            }

            return grab
        }

        const updateCardOrder = (cardElement) => {
            const cardLayer = document.querySelector("#card-layer")
            cardLayer.append(cardElement)
        }

        const updateCardTooltipPosition = (cardElement) => {
            const y = cardElement.getBoundingClientRect().y
            if (y < 500) {
                cardElement.querySelector(".game-card-tooltip").classList.add("force-in-view")
            } else {
                cardElement.querySelector(".game-card-tooltip").classList.remove("force-in-view")
            }
        }

        const updateCardHoverArea = (cardElement) => {
            const x = cardElement.getBoundingClientRect().x
            const y = cardElement.getBoundingClientRect().y
            const yourHaneHeight = document.querySelector("#your-hand").getBoundingClientRect().height - 10 //protection from play by grid snapping
            const deckPositions = [...document.querySelectorAll(".deck")].map(d => d.getBoundingClientRect())

            if (deckPositions.some(position => position.x === x && position.y === y)) {
                cardElement.setAttribute("data-hover-location", "deck")
            } else if (y > (document.documentElement.clientHeight - yourHaneHeight)) {
                cardElement.setAttribute("data-hover-location", "hand")
            } else if (y <  yourHaneHeight) {
                cardElement.setAttribute("data-hover-location", "opponent-hand")
            } else {
                cardElement.setAttribute("data-hover-location", "board")
            }
        }

        const updateCardArea = (cardElement) => {
            const x = cardElement.getBoundingClientRect().x
            const y = cardElement.getBoundingClientRect().y
            const yourHaneHeight = document.querySelector("#your-hand").getBoundingClientRect().height - 10 //protection from play by grid snapping
            const deckPositions = [...document.querySelectorAll(".deck")].map(d => d.getBoundingClientRect())

            if (deckPositions.some(position => position.x === x && position.y === y)) {
                cardElement.setAttribute("data-location", "deck")
            } else if (y > (document.documentElement.clientHeight - yourHaneHeight)) {
                cardElement.setAttribute("data-location", "hand")
            } else if (y <  yourHaneHeight) {
                cardElement.setAttribute("data-location", "opponent-hand")
            } else {
                cardElement.setAttribute("data-location", "board")
            }
        }

        const handleCardBehavior = (cardElement) => {
            const cardLocation = cardElement.getAttribute("data-location")

            switch (cardLocation) {
                case "deck":
                    if (cardElement.getAttribute("data-type") === "identity") {
                        cardElement.setAttribute("data-location", "board")
                        cardVisibility(cardElement, true, false, true)
                    } else {
                        cardVisibility(cardElement, false, true, false)
                    }
                    break

                case "hand":
                    cardElement.classList.remove("flipped")
                    cardVisibility(cardElement, true, false, true)
                    const yourHandRect = document.querySelector("#your-hand").getBoundingClientRect()
                    cardElement.style.top = yourHandRect.y + yourHandRect.height / 2 + "px"
                    snapToGrid(cardElement)
                    break

                case "opponent-hand":
                    cardElement.classList.remove("flipped")
                    cardVisibility(cardElement, false, true, false)
                    break

                case "board":
                    if (cardElement.getAttribute("data-side") === "corp") {
                        if (cardElement.getAttribute("data-type") === "operation" || cardElement.getAttribute("data-type") === "identity") {
                            cardVisibility(cardElement, true, false, true)
                        } else {
                            if (cardElement.getAttribute("data-side") === window.playerSide) {
                                cardVisibility(cardElement, false, true, true)
                            } else {
                                cardVisibility(cardElement, false, true, false)
                            }
                        }
                    } else {
                        cardVisibility(cardElement, true, false, true)
                    }
                    const yourHandY = document.querySelector("#your-hand").getBoundingClientRect().y
                    const cardY = cardElement.getBoundingClientRect().y
                    if (yourHandY - cardY < 75) {
                        cardElement.style.top = cardY - (75 - (yourHandY - cardY)) + "px"
                        snapToGrid(cardElement)
                    }
                    break

                case "bin":
                    cardVisibility(cardElement, true, false, true)
                    break
            }

            if (cardElement.getAttribute("data-type") === "ice" && cardLocation === "board") {
                cardElement.classList.add("rotated")
            } else {
                cardElement.classList.remove("rotated")
            }
        }

        function cardVisibility(cardElement, frontVisible, backVisible, tooltipVisible) {
            if (frontVisible) {
                cardElement.querySelector(".card-front").classList.remove("hidden")
            } else {
                cardElement.querySelector(".card-front").classList.add("hidden")
            }
            if (backVisible) {
                cardElement.querySelector(".card-back").classList.remove("hidden")
            } else {
                cardElement.querySelector(".card-back").classList.add("hidden")
            }
            if (tooltipVisible) {
                cardElement.querySelector(".game-card-tooltip").classList.remove("hidden")
            } else {
                cardElement.querySelector(".game-card-tooltip").classList.add("hidden")
            }
        }

        const createToken = (tokenName, x, y) => {
            const tokenElement = document.createElement("div")

            const innerElement = document.querySelector("#" + tokenName).cloneNode(true)
            innerElement.style.position = "absolute";
            innerElement.style.transform += "translate(-50%, -50%) translate(-10px, -10px)"
            tokenElement.append(innerElement)

            tokenElement.id = crypto.randomUUID()
            tokenElement.classList.add("token")
            tokenElement.style.left = x
            tokenElement.style.top = y
            tokenElement.addEventListener("mousedown", grabCard(tokenElement))

            const dualTokens = [
                ["credit", "advancement"],
                ["advancement", "credit"],
                ["power", "virus"],
                ["virus", "power"],
                ["tag", "bad-publicity"],
                ["bad-publicity", "tag"]
            ]
            dualTokens.filter(([key, value]) => key === tokenName).forEach(([key, value]) => {
                tokenElement.addEventListener("dblclick", e => {
                    e.preventDefault()
                    e.stopPropagation()

                    function flipToken(tokenElement) {
                        const newTokenName = tokenElement.firstElementChild.id === key ? value : tokenElement.firstElementChild.id === value ? key : tokenElement.firstElementChild.id
                        const newInnerElement = document.querySelector("#" + newTokenName).cloneNode(true)
                        newInnerElement.style.position = "absolute";
                        newInnerElement.style.transform += "translate(-50%, -50%) translate(-10px, -10px)"
                        tokenElement.replaceChild(newInnerElement, tokenElement.firstElementChild)

                        const stactedToken = tokenElement.querySelector(".token")
                        if (stactedToken) {
                            flipToken(stactedToken)
                        }
                    }
                    flipToken(tokenElement)
                })
            })
            tokenElement.addEventListener("auxclick", e => {
                e.preventDefault()
                e.stopPropagation()

                if (e.button === 1) {
                    const lastTokenInStack = tokenElement.querySelector("div:only-child").parentElement
                    lastTokenInStack.append(createToken(tokenElement.firstElementChild.id, "0px", "15px"))
                }
            })
            document.querySelector("#card-layer").appendChild(tokenElement)
            return tokenElement
        }

        ["credit", "advancement", "power", "virus", "tag", "bad-publicity", "brain-damage"].forEach(tokenName => {
            document.querySelector("#" + tokenName).addEventListener("mousedown", e => {
                e.preventDefault()

                const tokenElement = createToken(tokenName, e.clientX + "px", e.clientY + "px")
                grabCard(tokenElement)(e)
            })
        })

        const setupGame = () => {
            createDeck(allCards, document.querySelector("#corp-deck-list").value, "85vw", "75vh")
            const corpIndentity = document.querySelector("#corp-identity").value.trim()
            const corpIndentityElement = createCard(allCards.find(cardInfo => cardInfo.title === corpIndentity), "75vw", "75vh")

            createDeck(allCards, document.querySelector("#runner-deck-list").value, "15vw", "25vh")
            const runnerIndentity = document.querySelector("#runner-identity").value.trim()
            const runnerIndentityElement = createCard(allCards.find(cardInfo => cardInfo.title === runnerIndentity), "25vw", "25vh")
        }
        setupGame()
    </script>





    <style>
        html, body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        .flex-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }
        .player-hand {
            height: 150px;
            background-color: lightskyblue;
        }
        .board {
            flex-grow: 1;
            background-color: lightblue;
        }

        .deck {
            position: absolute;
            transform: translate(-50%, -50%) scale(.5);
        }
        .deck-card-back {
            position: absolute;
            transform: translate(-50%, -50%) translate(-5px, 5px);
            padding-left: 10px;
            padding-bottom: 10px;
            border: 5px solid black;
            border-radius: 11px;
            border-top-left-radius: 25px;
            border-bottom-right-radius: 25px;
            background-color: black;
        }
        .game-card {
            position: absolute;
            transform: translate(-50%, -50%) scale(.5);
            z-index: 1;
        }
        .game-card:hover {
            z-index: 10;
        }
        .card-front {
            transform: translate(-50%, -50%);
            border: 3px solid black;
            border-radius: 11px;
            background-color: black;
            overflow: hidden;
            position: absolute;
        }
        .card-back {
            transform: translate(-50%, -50%);
            border: 3px solid black;
            border-radius: 11px;
            background-color: black;
            overflow: hidden;
            position: absolute;
        }

        .game-card-tooltip {
            border: 3px solid black;
            border-radius: 11px;
            background-color: black;
            overflow: hidden;
            position: absolute;
            visibility: hidden;
            transform: scale(3.1415) translate(-30px, -230px) var(--force-in-view);
        }

        .game-card:hover .game-card-tooltip {
            visibility: visible;
        }

        .hidden {
            display: none;
        }
        .flipped>:not(.hidden) {
            display: none;
        }
        .flipped>.hidden {
            display: block;
        }
        .flipped>.card-front.hidden~.game-card-tooltip:not(.hidden) {
            display: block;
        }

        .game-card.rotated {
            transform: translate(-50%, -50%) scale(.5) rotate(90deg);
        }
        .rotated .game-card-tooltip {
            transform: rotate(-90deg) scale(3.1415) translate(45px, -210px) var(--force-in-view);
        }

        .token {
            position: absolute;
            z-index: 20;
            display: block !important;
        }
        .game-card>.token {
            transform: scale(2) translate(50%, 50%);
        }
        .game-card.rotated>.token {
            transform: rotate(-90deg) scale(2) translate(50%, 50%);
        }
        .token:hover {
            z-index: 25;
        }
        .token-bin {
            border: 1px lightgrey dashed;
            border-radius: 15px;
            border-width: 3px;
            color: lightgrey;
        }
        .token-bin-active {
            color: red;
            border-color: red;
        }

        .game-card[data-location="hand"]:not([data-hover-location="hand"])>* {
            box-shadow:
                0 0 5px rgba(165, 255, 47, 0.5),
                0 0 10px rgba(165, 255, 47, 0.5),
                0 0 20px rgba(165, 255, 47, 0.5),
                0 0 30px rgba(165, 255, 47, 0.5),
                0 0 40px rgba(165, 255, 47, 0.5);
        }

        .game-card:not([data-location="hand"])[data-hover-location="hand"]>* {
            box-shadow:
                0 0 5px rgba(255, 165, 0, 0.5),
                0 0 10px rgba(255, 165, 0, 0.5),
                0 0 20px rgba(255, 165, 0, 0.5),
                0 0 30px rgba(255, 165, 0, 0.5),
                0 0 40px rgba(255, 165, 0, 0.5);
        }

        .game-card[data-location="board"]>* {
            animation: glow-impulse 1s normal;
        }

        @keyframes glow-impulse {
            0% {
                box-shadow:
                0 0 5px rgba(255, 255, 255, 0),
                0 0 10px rgba(255, 255, 255, 0),
                0 0 20px rgba(255, 255, 255, 0),
                0 0 30px rgba(255, 255, 255, 0),
                0 0 40px rgba(255, 255, 255, 0);
            }
            5% {
                box-shadow:
                0 0 5px rgba(255, 255, 255, 1),
                0 0 10px rgba(255, 255, 255, 1),
                0 0 20px rgba(255, 255, 255, 1),
                0 0 30px rgba(255, 255, 255, 1),
                0 0 40px rgba(255, 255, 255, 1);
            }
            100% {
                box-shadow:
                0 0 5px rgba(255, 255, 255, 0),
                0 0 10px rgba(255, 255, 255, 0),
                0 0 20px rgba(255, 255, 255, 0),
                0 0 30px rgba(255, 255, 255, 0),
                0 0 40px rgba(255, 255, 255, 0);
            }
        }

        :root {
            --force-in-view: translate(0px, 0px)
        }

        .force-in-view {
            --force-in-view: translate(0px, 375px)
        }

        .grid-container {
            width: 100%;
            height: 100vh;
            background-image: 
                linear-gradient(to right, lightgray 1px, transparent 1px),
                linear-gradient(to bottom, lightgray 1px, transparent 1px);
            background-size: 25px 25px;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</body>

</html>